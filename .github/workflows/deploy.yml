name: Multistage Deployment

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # --- STAGE 1: Deploy to Testing (Automatic on Push) ---
  deploy-testing:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Inject Build Info
        run: |
            HASH=$(git rev-parse --short HEAD)
            DATE=$(date +'%Y-%m-%d %H:%M')
            sed -i "s|Local Development Build|Build: $HASH ($DATE)|g" index.html
      - name: Deploy to Testing Subfolder
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          destination_dir: testing
          keep_files: true

  # --- STAGE 2: Deploy to Production (Manual Trigger) ---
  deploy-prod:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Inject Build Info
        run: |
            HASH=$(git rev-parse --short HEAD)
            DATE=$(date +'%Y-%m-%d %H:%M')
            sed -i "s|Local Development Build|Build: $HASH ($DATE)|g" index.html
      - name: Deploy to Root (Production)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          keep_files: true